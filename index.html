<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entropy Audit Dashboard - Interactive M&V Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            padding: 30px;
        }

        .factors-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .category {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid #667eea;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            user-select: none;
        }

        .category-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
        }

        .category-weight {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .factor-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e1e8ed;
        }

        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .factor-name {
            font-weight: 500;
            color: #34495e;
        }

        .factor-weight {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .factor-input {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
            background: #dfe6e9;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .noise-value {
            min-width: 50px;
            text-align: right;
            font-weight: 600;
            color: #2c3e50;
        }

        .contribution {
            font-size: 0.85em;
            color: #95a5a6;
            margin-top: 5px;
        }

        .results-panel {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .entropy-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
        }

        .bulb-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #bulb {
            width: 120px;
            height: 120px;
            background-color: green;
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(255,255,255,0.3);
            transition: background-color 0.3s, opacity 0.3s;
        }

        .entropy-score {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
        }

        .entropy-status {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .breakdown {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .breakdown h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .category-bar {
            margin-bottom: 15px;
        }

        .category-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .bar-container {
            background: #ecf0f1;
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }

        .action-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
        }

        .action-header {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .action-content {
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .action-green {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .action-yellow {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .action-red {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .action-critical {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .action-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .action-details {
            font-size: 0.9em;
            line-height: 1.6;
        }

        .top-factors {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .top-factors h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .factor-rank {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .rank-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 15px;
        }

        .rank-details {
            flex: 1;
        }

        .rank-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .rank-contribution {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .collapsed .factor-item {
            display: none;
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        .collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Entropy Audit Dashboard</h1>
            <p>Interactive M&V Baseline Risk Assessment</p>
        </div>

        <!-- Baseline Model Info Section -->
        <div style="background: white; margin: 20px; padding: 25px; border-radius: 15px; border-left: 5px solid #667eea;">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;" onclick="toggleBaselineInfo()">
                <div>
                    <h2 style="color: #2c3e50; margin-bottom: 5px;">üìê How Entropy Arises from Baseline Models</h2>
                    <p style="color: #7f8c8d; margin: 0;">Click to learn about the EnergyPlus baseline structure</p>
                </div>
                <span id="baselineToggle" style="font-size: 1.5em; color: #667eea;">‚ñº</span>
            </div>

            <div id="baselineInfo" style="display: none; margin-top: 20px;">
                <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üèóÔ∏è The Baseline Model</h3>
                    <p style="line-height: 1.8; color: #34495e;">
                        The <strong>baseline</strong> is an <strong>EnergyPlus building energy simulation</strong> that represents
                        expected performance under controlled conditions. It includes:
                    </p>
                    <ul style="line-height: 1.8; color: #34495e; margin-top: 10px;">
                        <li><strong>Building Geometry</strong>: Zones, surfaces, materials with thermal properties</li>
                        <li><strong>HVAC Systems</strong>: Equipment topology, control sequences, design capacities</li>
                        <li><strong>Internal Loads</strong>: Occupancy schedules, lighting, equipment (plug loads)</li>
                        <li><strong>Environmental Inputs</strong>: Weather data, outdoor air, infiltration rates</li>
                        <li><strong>Operational Schedules</strong>: Operating hours, setpoints, ventilation</li>
                    </ul>
                </div>

                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">‚ö†Ô∏è How Entropy Arises: Six Degradation Pathways</h3>
                    <p style="line-height: 1.8; color: #34495e; margin-bottom: 15px;">
                        <strong>Entropy = Divergence between baseline predictions and measured reality</strong>
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 3px solid #3498db;">
                            <strong style="color: #3498db;">1. Measurement (31%)</strong>
                            <p style="margin-top: 8px; font-size: 0.9em; color: #555;">Sensors drift, data gaps, sampling errors obscure true performance</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 3px solid #9b59b6;">
                            <strong style="color: #9b59b6;">2. Model (46%)</strong>
                            <p style="margin-top: 8px; font-size: 0.9em; color: #555;">Wrong geometry, unknown parameters, calibration staleness</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 3px solid #27ae60;">
                            <strong style="color: #27ae60;">3. Environmental (15%)</strong>
                            <p style="margin-top: 8px; font-size: 0.9em; color: #555;">Setpoint changes, ventilation increases, envelope leaks</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 3px solid #e67e22;">
                            <strong style="color: #e67e22;">4. Operational (23%)</strong>
                            <p style="margin-top: 8px; font-size: 0.9em; color: #555;">Equipment degradation, maintenance variance, schedule drift</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 3px solid #e74c3c;">
                            <strong style="color: #e74c3c;">5. Economic/Regulatory (35%)</strong>
                            <p style="margin-top: 8px; font-size: 0.9em; color: #555;">Tariff changes, new codes, compliance mandates</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 3px solid #c0392b;">
                            <strong style="color: #c0392b;">6. System (23%)</strong>
                            <p style="margin-top: 8px; font-size: 0.9em; color: #555;">Occupancy changes, external shocks (COVID), behavioral adaptation</p>
                        </div>
                    </div>
                </div>

                <div style="background: #d4edda; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üîó EnergyPlus MCP Integration</h3>
                    <p style="line-height: 1.8; color: #34495e; margin-bottom: 10px;">
                        Use the <strong><a href="https://github.com/jskromer/energyplus-mcp" target="_blank" style="color: #667eea;">EnergyPlus MCP Server</a></strong>
                        to programmatically interact with baseline models:
                    </p>
                    <ol style="line-height: 1.8; color: #34495e; margin-top: 10px;">
                        <li>Load baseline IDF file and inspect building components</li>
                        <li>Run simulation with actual weather data</li>
                        <li>Extract time-series energy predictions</li>
                        <li>Compare predictions to measured utility data</li>
                        <li>Calculate deviations and map to entropy factors</li>
                        <li>Generate weighted entropy score (this dashboard)</li>
                    </ol>
                    <p style="margin-top: 15px; font-weight: 600; color: #2c3e50;">
                        üìÑ See <a href="BaselineModel_Structure.md" style="color: #667eea;">BaselineModel_Structure.md</a> for detailed workflow and examples
                    </p>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Left Panel: Factor Inputs -->
            <div class="factors-panel" id="factorsPanel">
                <!-- Categories will be dynamically generated -->
            </div>

            <!-- Right Panel: Results -->
            <div class="results-panel">
                <div class="entropy-display">
                    <div class="bulb-container">
                        <div id="bulb"></div>
                    </div>
                    <div class="entropy-score" id="entropyScore">0</div>
                    <div class="entropy-status" id="entropyStatus">Low Impact - Stable System</div>
                </div>

                <div class="breakdown">
                    <h3>üìä Category Breakdown</h3>
                    <div id="categoryBreakdown"></div>
                </div>

                <div class="action-panel">
                    <div class="action-header">‚ö° Recommended Action</div>
                    <div id="actionContent"></div>
                </div>

                <div class="top-factors">
                    <h3>üèÜ Top Contributing Factors</h3>
                    <div id="topFactors"></div>
                </div>

                <div class="controls">
                    <button class="btn" onclick="resetAll()">Reset All</button>
                    <button class="btn" onclick="loadScenario('low')">Low Entropy</button>
                    <button class="btn" onclick="loadScenario('moderate')">Moderate</button>
                    <button class="btn" onclick="loadScenario('high')">High Risk</button>
                </div>
            </div>
        </div>

        <!-- Baseline vs. Actual Visualization -->
        <div style="background: white; margin: 20px; padding: 25px; border-radius: 15px; border-left: 5px solid #667eea;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #2c3e50; margin: 0;">üìà Baseline vs. Actual: How Entropy Arises</h2>
                <button class="btn" onclick="toggleBaselineChart()" style="padding: 8px 20px;">Toggle Chart</button>
            </div>

            <div id="baselineChart" style="display: none;">
                <p style="color: #7f8c8d; line-height: 1.6; margin-bottom: 20px;">
                    This chart shows how entropy accumulates when measured energy consumption diverges from EnergyPlus baseline predictions.
                    The <strong style="color: #667eea;">gap between lines</strong> represents entropy factors in action.
                </p>

                <!-- Chart Canvas -->
                <div style="position: relative; height: 400px; background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <canvas id="comparisonCanvas"></canvas>
                </div>

                <!-- Legend -->
                <div style="display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 3px; background: #667eea;"></div>
                        <span style="color: #2c3e50; font-weight: 500;">EnergyPlus Baseline</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 3px; background: #e74c3c;"></div>
                        <span style="color: #2c3e50; font-weight: 500;">Measured Actual</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 30px; height: 20px; background: rgba(231, 76, 60, 0.1); border: 2px dashed #e74c3c;"></div>
                        <span style="color: #2c3e50; font-weight: 500;">Entropy (Divergence)</span>
                    </div>
                </div>

                <!-- Scenario Selector -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">Example Scenarios</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <button class="btn" onclick="loadBaselineScenario('stable')">Stable System (Low Entropy)</button>
                        <button class="btn" onclick="loadBaselineScenario('degrading')">Equipment Degrading</button>
                        <button class="btn" onclick="loadBaselineScenario('occupancy')">Occupancy Change</button>
                        <button class="btn" onclick="loadBaselineScenario('covid')">COVID-19 Shock</button>
                    </div>

                    <!-- Scenario Description -->
                    <div id="scenarioDescription" style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border-left: 3px solid #667eea;">
                        <p style="color: #34495e; margin: 0; line-height: 1.6;"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Factor definitions with weights
        const factorData = {
            "Measurement": {
                weight: 0.31,
                color: "#3498db",
                factors: [
                    { name: "Sensor Drift", weight: 0.08, description: "Days since calibration" },
                    { name: "Data Completeness", weight: 0.10, description: "% missing data" },
                    { name: "Sampling Frequency", weight: 0.06, description: "Temporal resolution" },
                    { name: "Measurement Error", weight: 0.07, description: "Instrument precision" }
                ]
            },
            "Model": {
                weight: 0.46,
                color: "#9b59b6",
                factors: [
                    { name: "Model Misspecification", weight: 0.12, description: "Wrong functional form" },
                    { name: "Parameter Uncertainty", weight: 0.09, description: "Coefficient CI" },
                    { name: "Omitted Variables", weight: 0.10, description: "Missing confounders" },
                    { name: "Calibration Staleness", weight: 0.08, description: "Time since update" },
                    { name: "Extrapolation Risk", weight: 0.07, description: "Out-of-range operation" }
                ]
            },
            "Environmental": {
                weight: 0.15,
                color: "#27ae60",
                factors: [
                    { name: "Temperature Deviation", weight: 0.04, description: "Setpoint drift" },
                    { name: "Humidity Control", weight: 0.03, description: "RH deviation" },
                    { name: "Lighting Standards", weight: 0.03, description: "Illumination changes" },
                    { name: "Air Quality Drift", weight: 0.03, description: "Ventilation rate" },
                    { name: "Pressure Control", weight: 0.02, description: "Building envelope" }
                ]
            },
            "Operational": {
                weight: 0.23,
                color: "#e67e22",
                factors: [
                    { name: "Energy Drift", weight: 0.08, description: "Efficiency loss" },
                    { name: "Equipment Degradation", weight: 0.06, description: "Performance decay" },
                    { name: "Maintenance Variance", weight: 0.04, description: "Missed PMs" },
                    { name: "Operating Hours Drift", weight: 0.05, description: "Schedule changes" }
                ]
            },
            "Economic/Regulatory": {
                weight: 0.35,
                color: "#e74c3c",
                factors: [
                    { name: "Tariff Changes", weight: 0.09, description: "Rate structure" },
                    { name: "Demand Charges", weight: 0.06, description: "Peak pricing" },
                    { name: "Regulatory Changes", weight: 0.08, description: "Code updates" },
                    { name: "Legal Requirements", weight: 0.07, description: "Compliance mandates" },
                    { name: "Market Shifts", weight: 0.05, description: "Energy volatility" }
                ]
            },
            "System": {
                weight: 0.23,
                color: "#c0392b",
                factors: [
                    { name: "Occupancy Changes", weight: 0.06, description: "Usage patterns" },
                    { name: "External Shocks", weight: 0.08, description: "Pandemic, disasters" },
                    { name: "Behavioral Adaptation", weight: 0.04, description: "Gaming, equation effects" },
                    { name: "Technology Changes", weight: 0.05, description: "Equipment replacement" }
                ]
            }
        };

        let factorValues = {};
        let blinkInterval = null;

        // Initialize
        function init() {
            renderFactors();
            calculateEntropy();
        }

        function renderFactors() {
            const panel = document.getElementById('factorsPanel');

            Object.keys(factorData).forEach(categoryName => {
                const category = factorData[categoryName];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.innerHTML = `
                    <div class="category-header" onclick="toggleCategory(this)">
                        <div class="category-title">
                            <span class="toggle-icon">‚ñº</span> ${categoryName}
                        </div>
                        <div class="category-weight">Total Weight: ${(category.weight * 100).toFixed(0)}%</div>
                    </div>
                    <div class="category-factors">
                        ${category.factors.map(factor => {
                            const factorId = `${categoryName}-${factor.name}`.replace(/\s+/g, '-');
                            factorValues[factorId] = 0;

                            return `
                                <div class="factor-item">
                                    <div class="factor-header">
                                        <div class="factor-name">${factor.name}</div>
                                        <div class="factor-weight">Weight: ${(factor.weight * 100).toFixed(0)}%</div>
                                    </div>
                                    <div style="font-size: 0.85em; color: #7f8c8d; margin-bottom: 8px;">${factor.description}</div>
                                    <div class="factor-input">
                                        <input type="range"
                                               class="slider"
                                               id="${factorId}"
                                               min="0"
                                               max="100"
                                               value="0"
                                               oninput="updateFactor('${factorId}', this.value, ${factor.weight})">
                                        <div class="noise-value" id="${factorId}-value">0%</div>
                                    </div>
                                    <div class="contribution" id="${factorId}-contribution">Contribution: 0.00 points</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                panel.appendChild(categoryDiv);
            });
        }

        function toggleCategory(header) {
            header.parentElement.classList.toggle('collapsed');
        }

        function updateFactor(factorId, value, weight) {
            factorValues[factorId] = parseInt(value);
            const noise = value / 100;
            const contribution = noise * weight * 100;

            document.getElementById(`${factorId}-value`).textContent = `${value}%`;
            document.getElementById(`${factorId}-contribution`).textContent =
                `Contribution: ${contribution.toFixed(2)} points`;

            calculateEntropy();
        }

        function calculateEntropy() {
            let totalEntropy = 0;
            let categoryContributions = {};
            let allContributions = [];

            // Calculate contributions
            Object.keys(factorData).forEach(categoryName => {
                const category = factorData[categoryName];
                let categoryTotal = 0;

                category.factors.forEach(factor => {
                    const factorId = `${categoryName}-${factor.name}`.replace(/\s+/g, '-');
                    const noise = factorValues[factorId] / 100;
                    const contribution = noise * factor.weight * 100;

                    categoryTotal += contribution;
                    totalEntropy += contribution;

                    allContributions.push({
                        name: factor.name,
                        category: categoryName,
                        contribution: contribution
                    });
                });

                categoryContributions[categoryName] = categoryTotal;
            });

            // Update display
            updateEntropyDisplay(totalEntropy);
            updateCategoryBreakdown(categoryContributions, totalEntropy);
            updateTopFactors(allContributions);
            updateActionPanel(totalEntropy);
        }

        function updateEntropyDisplay(entropy) {
            const score = Math.round(entropy);
            document.getElementById('entropyScore').textContent = score;

            const bulb = document.getElementById('bulb');
            const statusEl = document.getElementById('entropyStatus');

            // Clear any existing blink
            if (blinkInterval) {
                clearInterval(blinkInterval);
                blinkInterval = null;
            }

            if (score <= 15) {
                bulb.style.backgroundColor = 'green';
                bulb.style.opacity = score / 15;
                statusEl.textContent = 'Low Impact - Stable System';
            } else if (score <= 50) {
                bulb.style.backgroundColor = 'yellow';
                bulb.style.opacity = (score - 15) / 35;
                statusEl.textContent = 'Moderate Impact - Noise Present';
            } else {
                bulb.style.backgroundColor = 'red';
                statusEl.textContent = 'High Impact - Critical Noise';

                const blinkSpeed = 500 - ((score - 50) / 50) * 450;
                blinkInterval = setInterval(() => {
                    bulb.style.opacity = bulb.style.opacity == '1' ? '0.1' : '1';
                }, blinkSpeed);
            }
        }

        function updateCategoryBreakdown(contributions, total) {
            const container = document.getElementById('categoryBreakdown');
            container.innerHTML = '';

            Object.keys(contributions).forEach(category => {
                const value = contributions[category];
                const percentage = total > 0 ? (value / total * 100) : 0;

                const barDiv = document.createElement('div');
                barDiv.className = 'category-bar';
                barDiv.innerHTML = `
                    <div class="category-bar-label">
                        <span>${category}</span>
                        <span>${value.toFixed(1)} pts (${percentage.toFixed(0)}%)</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: ${percentage}%">
                            ${percentage > 10 ? percentage.toFixed(0) + '%' : ''}
                        </div>
                    </div>
                `;
                container.appendChild(barDiv);
            });
        }

        function updateTopFactors(contributions) {
            const sorted = contributions
                .filter(f => f.contribution > 0)
                .sort((a, b) => b.contribution - a.contribution)
                .slice(0, 5);

            const container = document.getElementById('topFactors');
            container.innerHTML = sorted.length > 0
                ? sorted.map((factor, index) => `
                    <div class="factor-rank">
                        <div class="rank-number">${index + 1}</div>
                        <div class="rank-details">
                            <div class="rank-name">${factor.name}</div>
                            <div class="rank-contribution">${factor.category} ‚Ä¢ ${factor.contribution.toFixed(2)} points</div>
                        </div>
                    </div>
                `).join('')
                : '<p style="text-align: center; color: #95a5a6;">No factors contributing yet</p>';
        }

        function updateActionPanel(entropy) {
            const container = document.getElementById('actionContent');
            const score = Math.round(entropy);

            let className, title, details, frequency;

            if (score <= 15) {
                className = 'action-green';
                title = '‚úÖ Continue Standard M&V';
                details = 'System is stable with low entropy. Continue with routine protocols and annual updates.';
                frequency = 'Update Frequency: Annual';
            } else if (score <= 50) {
                className = 'action-yellow';
                title = '‚ö†Ô∏è Enhanced Monitoring Required';
                details = 'Moderate entropy detected. Increase monitoring frequency and consider recalibration of baseline model.';
                frequency = 'Update Frequency: Quarterly';
            } else if (score <= 75) {
                className = 'action-red';
                title = 'üö® Urgent: Redesign Baseline';
                details = 'High entropy detected. Immediate action required: redesign baseline with adaptive protocols and scenario analysis.';
                frequency = 'Update Frequency: Monthly';
            } else {
                className = 'action-critical';
                title = 'üî¥ CRITICAL: Force Majeure';
                details = 'Critical entropy level. Baseline is invalid. Invoke force majeure protocols and suspend M&V pending resolution.';
                frequency = 'Update Frequency: Real-time crisis management';
            }

            container.innerHTML = `
                <div class="action-content ${className}">
                    <div class="action-title">${title}</div>
                    <div class="action-details">${details}</div>
                    <div class="action-details" style="margin-top: 10px; font-weight: 600;">${frequency}</div>
                </div>
            `;
        }

        function resetAll() {
            Object.keys(factorValues).forEach(factorId => {
                factorValues[factorId] = 0;
                const slider = document.getElementById(factorId);
                if (slider) slider.value = 0;
                document.getElementById(`${factorId}-value`).textContent = '0%';
                document.getElementById(`${factorId}-contribution`).textContent = 'Contribution: 0.00 points';
            });
            calculateEntropy();
        }

        function loadScenario(scenario) {
            resetAll();

            const scenarios = {
                low: {
                    'Measurement-Sensor-Drift': 10,
                    'Measurement-Data-Completeness': 5,
                    'Model-Model-Misspecification': 5
                },
                moderate: {
                    'Measurement-Sensor-Drift': 40,
                    'Measurement-Data-Completeness': 20,
                    'Model-Calibration-Staleness': 50,
                    'Environmental-Temperature-Deviation': 30,
                    'Operational-Energy-Drift': 25
                },
                high: {
                    'Measurement-Sensor-Drift': 66,
                    'Model-Calibration-Staleness': 50,
                    'Model-Omitted-Variables': 30,
                    'Environmental-Temperature-Deviation': 75,
                    'Operational-Energy-Drift': 80,
                    'Economic/Regulatory-Tariff-Changes': 50,
                    'Economic/Regulatory-Regulatory-Changes': 60,
                    'System-Occupancy-Changes': 75,
                    'System-External-Shocks': 80
                }
            };

            const values = scenarios[scenario];
            Object.keys(values).forEach(factorId => {
                const slider = document.getElementById(factorId);
                if (slider) {
                    slider.value = values[factorId];
                    const weight = parseFloat(slider.getAttribute('oninput').match(/[\d.]+/)[0]);
                    updateFactor(factorId, values[factorId], weight);
                }
            });
        }

        // Toggle baseline info section
        function toggleBaselineInfo() {
            const info = document.getElementById('baselineInfo');
            const toggle = document.getElementById('baselineToggle');

            if (info.style.display === 'none') {
                info.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                info.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }

        // Toggle baseline chart
        function toggleBaselineChart() {
            const chart = document.getElementById('baselineChart');
            chart.style.display = chart.style.display === 'none' ? 'block' : 'none';

            if (chart.style.display === 'block') {
                // Initialize chart when first shown
                loadBaselineScenario('stable');
            }
        }

        // Draw baseline vs. actual comparison chart
        function drawComparisonChart(baselineData, actualData, scenario) {
            const canvas = document.getElementById('comparisonCanvas');
            const ctx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = canvas.parentElement.clientWidth - 40;
            canvas.height = 360;

            const width = canvas.width;
            const height = canvas.height;
            const padding = 50;
            const graphWidth = width - 2 * padding;
            const graphHeight = height - 2 * padding;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Find max value for scaling
            const maxValue = Math.max(...baselineData, ...actualData) * 1.1;

            // Draw grid lines
            ctx.strokeStyle = '#e1e8ed';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (graphHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();

                // Y-axis labels
                const value = maxValue - (maxValue / 5) * i;
                ctx.fillStyle = '#7f8c8d';
                ctx.font = '12px Segoe UI';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(value).toLocaleString() + ' kWh', padding - 10, y + 4);
            }

            // Draw X-axis labels (months)
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            ctx.fillStyle = '#7f8c8d';
            ctx.font = '12px Segoe UI';
            ctx.textAlign = 'center';
            months.forEach((month, i) => {
                const x = padding + (graphWidth / 11) * i;
                ctx.fillText(month, x, height - padding + 20);
            });

            // Helper function to get point coordinates
            function getPoint(index, value) {
                const x = padding + (graphWidth / 11) * index;
                const y = padding + graphHeight - (value / maxValue * graphHeight);
                return { x, y };
            }

            // Fill area between lines (entropy region)
            ctx.fillStyle = 'rgba(231, 76, 60, 0.1)';
            ctx.beginPath();
            ctx.moveTo(getPoint(0, baselineData[0]).x, getPoint(0, baselineData[0]).y);
            baselineData.forEach((value, i) => {
                const point = getPoint(i, value);
                ctx.lineTo(point.x, point.y);
            });
            for (let i = actualData.length - 1; i >= 0; i--) {
                const point = getPoint(i, actualData[i]);
                ctx.lineTo(point.x, point.y);
            }
            ctx.closePath();
            ctx.fill();

            // Draw baseline line (EnergyPlus)
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();
            baselineData.forEach((value, i) => {
                const point = getPoint(i, value);
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            });
            ctx.stroke();

            // Draw baseline points
            ctx.fillStyle = '#667eea';
            baselineData.forEach((value, i) => {
                const point = getPoint(i, value);
                ctx.beginPath();
                ctx.arc(point.x, point.y, 4, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw actual line (measured)
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 3;
            ctx.beginPath();
            actualData.forEach((value, i) => {
                const point = getPoint(i, value);
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            });
            ctx.stroke();

            // Draw actual points
            ctx.fillStyle = '#e74c3c';
            actualData.forEach((value, i) => {
                const point = getPoint(i, value);
                ctx.beginPath();
                ctx.arc(point.x, point.y, 4, 0, Math.PI * 2);
                ctx.fill();
            });

            // Calculate statistics
            const avgDeviation = actualData.reduce((sum, actual, i) => {
                return sum + ((actual - baselineData[i]) / baselineData[i] * 100);
            }, 0) / actualData.length;

            const totalBaseline = baselineData.reduce((a, b) => a + b, 0);
            const totalActual = actualData.reduce((a, b) => a + b, 0);
            const annualDeviation = ((totalActual - totalBaseline) / totalBaseline * 100);

            // Add statistics overlay
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fillRect(width - padding - 180, padding + 10, 170, 80);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.strokeRect(width - padding - 180, padding + 10, 170, 80);

            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px Segoe UI';
            ctx.textAlign = 'left';
            ctx.fillText('Annual Statistics', width - padding - 170, padding + 30);

            ctx.font = '12px Segoe UI';
            ctx.fillText(`Avg Deviation: ${avgDeviation.toFixed(1)}%`, width - padding - 170, padding + 50);
            ctx.fillText(`Total Baseline: ${totalBaseline.toLocaleString()}`, width - padding - 170, padding + 65);
            ctx.fillText(`Total Actual: ${totalActual.toLocaleString()}`, width - padding - 170, padding + 80);
        }

        // Load baseline scenario
        function loadBaselineScenario(scenario) {
            const scenarios = {
                stable: {
                    name: 'Stable System (Low Entropy)',
                    baseline: [125000, 110000, 95000, 85000, 90000, 110000, 130000, 135000, 115000, 95000, 105000, 120000],
                    actual: [127000, 112000, 93000, 87000, 88000, 108000, 132000, 137000, 117000, 93000, 107000, 118000],
                    description: '‚úÖ Model calibrated correctly. Minor variations (+/- 3%) due to weather and occupancy noise. Entropy Score: ~8 (Green Zone). No action needed.',
                    entropyFactors: {
                        'Measurement-Sensor-Drift': 5,
                        'Measurement-Data-Completeness': 2,
                        'Model-Calibration-Staleness': 3
                    }
                },
                degrading: {
                    name: 'Equipment Degrading',
                    baseline: [125000, 110000, 95000, 85000, 90000, 110000, 130000, 135000, 115000, 95000, 105000, 120000],
                    actual: [128000, 115000, 99000, 91000, 97000, 121000, 145000, 153000, 131000, 108000, 119000, 136000],
                    description: '‚ö†Ô∏è Chiller efficiency degrading over summer months (Jun-Sep). Energy drift +12%. Deferred maintenance causing 15% performance loss. Entropy Score: ~28 (Yellow Zone). Recommend quarterly recalibration.',
                    entropyFactors: {
                        'Operational-Energy-Drift': 50,
                        'Operational-Equipment-Degradation': 60,
                        'Operational-Maintenance-Variance': 40,
                        'Model-Calibration-Staleness': 20
                    }
                },
                occupancy: {
                    name: 'Occupancy Change (Hybrid Work)',
                    baseline: [125000, 110000, 95000, 85000, 90000, 110000, 130000, 135000, 115000, 95000, 105000, 120000],
                    actual: [100000, 88000, 76000, 68000, 72000, 88000, 104000, 108000, 92000, 76000, 84000, 96000],
                    description: 'üìâ 30% WFH adoption reduces internal loads. Baseline over-predicts by ~20%. Occupancy schedules in EnergyPlus no longer valid. Entropy Score: ~35 (Yellow Zone). Update baseline with new occupancy patterns.',
                    entropyFactors: {
                        'System-Occupancy-Changes': 70,
                        'Operational-Operating-Hours-Drift': 50,
                        'Model-Omitted-Variables': 30,
                        'Environmental-Temperature-Deviation': 25
                    }
                },
                covid: {
                    name: 'COVID-19 External Shock',
                    baseline: [125000, 110000, 95000, 85000, 90000, 110000, 130000, 135000, 115000, 95000, 105000, 120000],
                    actual: [125000, 110000, 50000, 35000, 40000, 55000, 75000, 80000, 90000, 85000, 95000, 100000],
                    description: 'üö® COVID-19 lockdown (Mar-May). Building closed, then phased reopening with 60% occupancy + enhanced ventilation. Baseline completely invalid. Entropy Score: ~72 (Red Zone). Force majeure condition - baseline redesign required.',
                    entropyFactors: {
                        'System-External-Shocks': 95,
                        'System-Occupancy-Changes': 80,
                        'Economic/Regulatory-Regulatory-Changes': 70,
                        'Environmental-Air-Quality-Drift': 60,
                        'Operational-Operating-Hours-Drift': 75,
                        'Model-Omitted-Variables': 80
                    }
                }
            };

            const data = scenarios[scenario];

            // Draw chart
            drawComparisonChart(data.baseline, data.actual, scenario);

            // Update description
            const descEl = document.getElementById('scenarioDescription').querySelector('p');
            descEl.textContent = data.description;

            // Update factor sliders to match scenario
            resetAll();
            Object.keys(data.entropyFactors).forEach(factorId => {
                const slider = document.getElementById(factorId);
                if (slider) {
                    const value = data.entropyFactors[factorId];
                    slider.value = value;
                    const weight = parseFloat(slider.getAttribute('oninput').match(/[\d.]+/)[0]);
                    updateFactor(factorId, value, weight);
                }
            });
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
